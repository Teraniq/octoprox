version: "3.8"

services:
  traefik:
    image: traefik:v3.1
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:8080"
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - mcpnet

  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    privileged: true
    environment:
      - CONTAINERS=1
      - ALLOW_START=1
      - ALLOW_STOP=1
      - IMAGES=1
      - VOLUMES=1
      - NETWORKS=1
      - POST=1
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - mcpnet

  workspace-manager:
    build: ./workspace-manager
    container_name: workspace-manager
    environment:
      - DATABASE_URL=sqlite:///./data/manager.db
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:8080}
      # SECURITY: SECRET_KEY must be set to a secure random value (min 32 chars)
      # Generate with: openssl rand -base64 32
      - SECRET_KEY=${SECRET_KEY}
      # SECURITY: Bootstrap admin credentials MUST be changed from defaults
      # These are required - the app will fail to start if not set
      - BOOTSTRAP_ADMIN_USERNAME=${BOOTSTRAP_ADMIN_USERNAME}
      - BOOTSTRAP_ADMIN_PASSWORD=${BOOTSTRAP_ADMIN_PASSWORD}
      - WORKSPACE_IMAGE=mcp-gitfs:latest
      - DOCKER_NETWORK=mcpnet
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      # Docker socket access is proxied through docker-socket-proxy to limit host exposure.
      # JWT Configuration for NEXUSGATE integration
      # SECURITY: JWT_SECRET_KEY must be at least 32 characters long
      # Generate with: openssl rand -base64 64
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-15}
      - NEXUSGATE_INTEGRATION_ENABLED=${NEXUSGATE_INTEGRATION_ENABLED:-false}
      - INTROSPECT_SECRET=${INTROSPECT_SECRET}
      # Rate Limiting Configuration
      - API_RATE_LIMIT=${API_RATE_LIMIT:-200}
      - AUTH_RATE_LIMIT=${AUTH_RATE_LIMIT:-60}
      # HTTPS Enforcement Configuration
      - ENFORCE_HTTPS=${ENFORCE_HTTPS:-false}
      - HSTS_MAX_AGE=${HSTS_MAX_AGE:-31536000}
      - HSTS_INCLUDE_SUBDOMAINS=${HSTS_INCLUDE_SUBDOMAINS:-true}
    depends_on:
      - docker-socket-proxy
    volumes:
      - manager-data:/app/data
    read_only: true
    tmpfs: ["/tmp:noexec,nosuid,size=100m"]
    security_opt: ["no-new-privileges:true"]
    cap_drop: ["ALL"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.manager.rule=PathPrefix(`/app`) && !PathPrefix(`/app/internal`)"
      - "traefik.http.routers.manager.entrypoints=web"
      - "traefik.http.routers.manager.middlewares=manager-stripprefix"
      - "traefik.http.middlewares.manager-stripprefix.stripprefix.prefixes=/app"
      - "traefik.http.services.manager.loadbalancer.server.port=8000"
    networks:
      - mcpnet
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M

  mcp-gitfs:
    image: mcp-gitfs:latest
    build: ./workspace-mcp
    profiles: ["build"]
    networks:
      - mcpnet

volumes:
  manager-data:

networks:
  mcpnet:
    name: mcpnet
